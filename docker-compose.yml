services:
  postgres:
    image: postgres:16-alpine
    container_name: planka-db
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-planka}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d ${DB_NAME:-planka} -U ${DB_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  planka:
    build:
      context: ./apps/planka
      dockerfile: Dockerfile
    container_name: planka-app
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - BASE_URL=${BASE_URL:-http://localhost:3000}
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/${DB_NAME:-planka}
      - SECRET_KEY=${PLANKA_SECRET_KEY}
    ports:
      - "3001:1337"
    volumes:
      - ./data/planka:/app/public/user-data
    deploy:
      resources:
        limits:
          memory: 512M

  bridge-api:
    build:
      context: .
      dockerfile: apps/bridge-api/Dockerfile
    container_name: planka-bridge
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://${DB_USER:-postgres}:${DB_PASSWORD:-postgres}@postgres:5432/${DB_NAME:-planka}
      - PLANKA_URL=http://planka:1337
      - BOARD_ID=${BOARD_ID}
      - LIST_ID=${LIST_ID}
      - USER_EMAIL=${PLANKA_USER}
      - USER_PASSWORD=${USER_PASSWORD}
      - USER_WHITELIST_MAPPING=${USER_WHITELIST_MAPPING}
      # WhatsApp session path â€” must match volume mount below
      - WA_SESSION_PATH=/app/data/whatsapp-session
    volumes:
      - ./data/whatsapp-session:/app/data/whatsapp-session
      - ./data/whatsapp-contacts.json:/app/data/whatsapp-contacts.json
    ports:
      - "3000:3000"
    deploy:
      resources:
        limits:
          memory: 256M

  db-backup:
    image: postgres:16-alpine
    container_name: planka-db-backup
    restart: unless-stopped
    environment:
      - PGPASSWORD=${DB_PASSWORD:-postgres}
    volumes:
      - ./data/backups:/backups
    entrypoint: >
      sh -c " echo 'DB Backup Service Started'; while true; do
        echo \"[$(date)] Backing up database to /backups/portable_backup.sql... \";
        pg_dump -h postgres -U postgres planka > /backups/portable_backup.sql;
        sleep 600;
      done"
    depends_on:
      postgres:
        condition: service_healthy

networks:
  default:
    name: planka-network

volumes:
  postgres_data:
